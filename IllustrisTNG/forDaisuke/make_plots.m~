
illustris.utils.set_illUnits(snap);

global illUnits

% read in data
loadFofSub
subsInfo = illustris.infrastructure.build_sub_fof_connection(subs,fofs);
%load('/home/zinger/workProjects/matlab_scripts/IllustrisTNG/matFiles/gasProperties_snp99_TNG100.mat')

% define stellar mass
massAllGals= double(subs.SubhaloMassInRadType(illustris.partTypeNum('stars')+1,:).*illUnits.massUnit); % stellar mass within 2*rhalf

%define host mass

% set mask
massThresh=10^9;
satMask=illustris.infrastructure.generateMask('subs',subs','fofs',fofs,'mass',massThresh,'snap',snap,'sats');
centralMask=illustris.infrastructure.generateMask('subs',subs','fofs',fofs,'mass',massThresh,'snap',snap,'centrals');

r200c=double(fofs.Group_R_Crit200(subsInfo.hostFof+1));
m200c=log10(double(fofs.Group_M_Crit200(subsInfo.hostFof+1).*illUnits.massUnit));



% calculate distance
global LBox
for i=1:3
    dx=abs(double(subs.SubhaloPos(i,:)-fofs.GroupPos(i,subsInfo.hostFof+1)));
    msk=dx>0.5.*LBox;
    
    
    dx(msk)=abs(dx(msk)-LBox);
    
    
    xx(i,:)=dx.^2;
    
    
end

radPosition=sqrt(sum(xx,1))./r200c;
clear xx

% calculate sSFR
ssfr=illustris.utils.calc_ssfr(subs,'base',0);


% bin the distances
binEdges=0.1:0.2:1.5;
binInd=discretize(radPosition,binEdges);
rbin=binEdges(1:end-1)+0.5.*diff(binEdges);

%% run with all galaxies - includes ssfr=0

%bin by host mass;
mask11=satMask & m200c>=11 & m200c<12;
mask12=satMask & m200c>=12 & m200c<13;
mask13=satMask & m200c>=13 & m200c<14;
mask14=satMask & m200c>=14 & m200c<15;


ssfrAvg=zeros(4,length(binEdges)-1);

for i=1:length(binEdges)-1
    %mask=mask11 & binInd==i;
    ssfrAvg(1,i)=mean(ssfr(mask11 & binInd==i));
    ssfrAvg(2,i)=mean(ssfr(mask12 & binInd==i));
    ssfrAvg(3,i)=mean(ssfr(mask13 & binInd==i));
    ssfrAvg(4,i)=mean(ssfr(mask14 & binInd==i));
    
end


% add in the obs data

load('/home/zinger/workProjects/matlab_scripts/IllustrisTNG/forDaisuke/ssfr_rpos_dataGrab.mat')
cc=brewermap(8,'Set1');

h=[];
figure

for i=1:4
    yy=log10(ssfrAvg(i,:));
    
    switch i
        case 1
            colo=cc(2,:);
            nam='11-12, TNG';
        case 2
            colo=cc(6,:);
            nam='12-13, TNG';
            
        case 3
            colo=cc(3,:);
            nam='13-14, TNG';
            
        case 4
            colo=cc(1,:);
            nam='14-15, TNG';
            
    end
    h(i)=plot(rbin,yy,'color',colo,'DisplayName',nam,'--');
    if i==1; hold on; end
end

 % obs
for i=5:6
        
    switch i
        case 5
            xx=ssfr_rpos_11_main(2,:);
            yy=ssfr_rpos_11_main(1,:);
            pos=ssfr_rpos_11_top(1,:)-ssfr_rpos_11_main(1,:);
            neg=ssfr_rpos_11_main(1,:)-ssfr_rpos_11_bottom(1,:);
            colo=cc(2,:);
            nam='11-12, Obs';
        case 6
            xx=ssfr_rpos_12_main(2,:);
            yy=ssfr_rpos_12_main(1,:);
            pos=ssfr_rpos_12_top(1,:)-ssfr_rpos_12_main(1,:);
            neg=ssfr_rpos_12_main(1,:)-ssfr_rpos_12_bottom(1,:);
            colo=cc(6,:);
            nam='12-13, Obs';
            
        case 7
            xx=ssfr_rpos_13_main(2,:);
            yy=ssfr_rpos_13_main(1,:);
            pos=ssfr_rpos_13_top(1,:)-ssfr_rpos_13_main(1,:);
            neg=ssfr_rpos_13_main(1,:)-ssfr_rpos_13_bottom(1,:);
            colo=cc(3,:);
            nam='13-14, Obs';
            
        case 8
            xx=ssfr_rpos_14_main(2,:);
            yy=ssfr_rpos_14_main(1,:);
            pos=ssfr_rpos_14_top(1,:)-ssfr_rpos_14_main(1,:);
            neg=ssfr_rpos_14_main(1,:)-ssfr_rpos_14_bottom(1,:);
            colo=cc(1,:);
            nam='14-15, Obs';
            
    end
   
    
   
    
    h(i)=errorbar(xx,yy,neg,pos,'color',cc(2,:),...
        'DisplayName',nam);
end
    
    
    hl=legend(h);
    
    xlim([0 1.5])
    ylim([-12 -9])
    
    
    %% run only with galaxies with non-zero ssfr - includes ssfr=0
    
    %bin by host mass;
    mask11=satMask & m200c>=11 & m200c<12 & ssfr~=0;
    mask12=satMask & m200c>=12 & m200c<13 & ssfr~=0;
    mask13=satMask & m200c>=13 & m200c<14 & ssfr~=0;
    mask14=satMask & m200c>=14 & m200c<15 & ssfr~=0;
    
    
    ssfrAvg=zeros(4,length(binEdges)-1);
    
    for i=1:length(binEdges)-1
        %mask=mask11 & binInd==i;
        ssfrAvg(1,i)=mean(ssfr(mask11 & binInd==i));
        ssfrAvg(2,i)=mean(ssfr(mask12 & binInd==i));
        ssfrAvg(3,i)=mean(ssfr(mask13 & binInd==i));
        ssfrAvg(4,i)=mean(ssfr(mask14 & binInd==i));
        
    end
    
    % add in the obs data
    
    load('/home/zinger/workProjects/matlab_scripts/IllustrisTNG/forDaisuke/ssfr_rpos_dataGrab.mat')
    cc=brewermap(8,'Set1');
    
    h=[];
    figure
    
    for i=1:4
        yy=log10(ssfrAvg(i,:));
        
        switch i
            case 1
                colo=cc(2,:);
                nam='11-12, TNG';
            case 2
                colo=cc(6,:);
                nam='12-13, TNG';
                
            case 3
                colo=cc(3,:);
                nam='13-14, TNG';
                
            case 4
                colo=cc(1,:);
                nam='14-15, TNG';
                
        end
        h(i)=plot(rbin,yy,'color',colo,'DisplayName',nam);
        hold on
    end
    
    
    % obs
    for i=5:8
        
        
    h(5)=errorbar(ssfr_rpos_11_main(2,:),ssfr_rpos_11_main(2,:)
    
    
    
    rbin,log10(ssfrAvg(1,:)),'color',cc(2,:),...
        'DisplayName','11-12');
    hold on
    h(6)=plot(rbin,log10(ssfrAvg(2,:)),'color',cc(6,:),...
        'DisplayName','12-13');
    h(7)=plot(rbin,log10(ssfrAvg(3,:)),'color',cc(3,:),...
        'DisplayName','13-14');
    h(8)=plot(rbin,log10(ssfrAvg(4,:)),'color',cc(1,:),...
        'DisplayName','14-15');
    
    
    
    
    hl=legend(h);
    
    xlim([0 1.5])
    ylim([-12 -9])
